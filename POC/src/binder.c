#include <stdio.h>
#include <errno.h>
#include <stddef.h>
#include <sys/mman.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include "binder.h"

struct binder_state *binder_open(const char* binder_driver, size_t mapsize)
{
    struct binder_state *bs;
    // 1. binder driver open
    bs = calloc(1, sizeof(*bs));
    if((bs->fd = open(binder_driver, O_RDWR)) < 0 ){
        fprintf(stderr, "[-] binder open error: %s\n", strerror(errno));
        free(bs);
        return NULL;
    }
    bs->mapsize = mapsize;
    if((bs->mapped = mmap(NULL, mapsize, PROT_READ, MAP_PRIVATE, bs->fd, 0)) == MAP_FAILED){ 
        fprintf(stderr, "[-] binder map error\n", strerror(errno));
        close(bs->fd);
        return NULL;
    }
    printf("[+] binder map success\n");
    return bs;
}

void binder_close(struct binder_state *bs)
{
    munmap(bs->mapped, bs->mapsize);
    close(bs->fd);
    free(bs);
}
